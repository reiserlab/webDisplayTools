# Protocol YAML Roundtrip Testing

Validates that YAML protocol files generated by the **web experiment designer** (`experiment_designer.html`) are fully compatible with the **MATLAB experiment runner** (`ProtocolParser` + `ProtocolRunner`).

## Architecture

```
Web (JavaScript)                    MATLAB
─────────────────                   ──────────────────────
experiment_designer.html            ProtocolParser.m
  └─ generateYAML()                   └─ parse()
       │                                    │
       ▼                                    ▼
  V1 Protocol YAML ───────────────> Parsed protocol struct
       │                                    │
       │                                    ▼
       │                            ProtocolRunner constructor
       │                              (validates structure)
       ▼
  simpleYAMLParse()
    (web-side parse-back)
```

### Test Coverage

| Layer | Test | Runs in CI? |
|-------|------|-------------|
| Web YAML generation + parse | `test-protocol-roundtrip.js` | Yes (Node.js) |
| Web YAML → file generation | `generate-roundtrip-protocol.js` | Yes (Node.js) |
| MATLAB parse + validate | `validate_web_protocol_roundtrip.m` | No (needs MATLAB license) |
| MATLAB ProtocolRunner construction | `validate_web_protocol_roundtrip.m` | No (needs MATLAB license) |

## Running Tests

### Web-side CI test (no dependencies)

```bash
cd webDisplayTools
node tests/test-protocol-roundtrip.js
```

Tests 49 checks across 5 suites:
1. **V1 Generate → Parse Roundtrip** — full field-by-field comparison
2. **Comment-Handling Regression** — comments between conditions (bug fix validation)
3. **Excluded Phases** — pretrial/intertrial/posttrial with `include: false`
4. **Numeric Type Preservation** — ints, floats, booleans parse correctly
5. **Inline Comments** — comments don't interfere with parsing

Exit code 0 = all passed, 1 = failures.

### Re-generate test YAML for MATLAB

```bash
cd webDisplayTools
node tests/generate-roundtrip-protocol.js --outdir ../maDisplayTools/tests/web_generated_patterns
```

Generates:
- `test_protocol_v1.yaml` — V1 protocol with 3 conditions
- `test_protocol_manifest.json` — expected values for MATLAB validation

The generator also runs 27 self-verification checks.

### MATLAB validation (requires MATLAB license)

```matlab
cd maDisplayTools
results = validate_web_protocol_roundtrip('v1');
```

Tests 28 checks:
1. ProtocolParser can parse the YAML
2. Version = 1
3. Experiment info (name)
4. Arena config (generation, rows, cols)
5. Experiment structure (repetitions)
6. Number of conditions = 3
7. Per-condition: id, pattern, duration, frame_rate, mode (x3 conditions)
8. Phase includes (pretrial, intertrial, posttrial)
9. Pretrial command count = 4
10. ProtocolRunner construction (validates full pipeline)

V2 test available but stubbed: `validate_web_protocol_roundtrip('v2')` returns early until V2 format is finalized.

## Files

### Web side (`webDisplayTools/`)

| File | Purpose |
|------|---------|
| `tests/test-protocol-roundtrip.js` | CI-ready regression test (49 checks) |
| `tests/generate-roundtrip-protocol.js` | YAML + manifest generator for MATLAB validation |

### MATLAB side (`maDisplayTools/`)

| File | Purpose |
|------|---------|
| `tests/validate_web_protocol_roundtrip.m` | MATLAB validation (28 checks, parameterized V1/V2) |
| `tests/web_generated_patterns/test_protocol_v1.yaml` | Generated test YAML |
| `tests/web_generated_patterns/test_protocol_manifest.json` | Expected values manifest |

## What to Update When Changing YAML Format

### Adding new fields to V1

1. Update `generateV1Protocol()` in both:
   - `generate-roundtrip-protocol.js` (generates files)
   - `test-protocol-roundtrip.js` (in-memory test)
2. Add expected values to the `testProtocol` definition
3. Add check assertions
4. Re-generate: `node tests/generate-roundtrip-protocol.js --outdir ...`
5. Update `validate_web_protocol_roundtrip.m` with new field checks
6. Update manifest expected values count

### Adding V2 support

1. Add `generateV2Protocol()` to generator and test scripts
2. Remove the `skip` return from `validate_web_protocol_roundtrip('v2')`
3. Add V2-specific checks (rig config, plugins, etc.)
4. Generate V2 test YAML: update generator's `--version 2` support

### Changing `experiment_designer.html` YAML output

After modifying `generateYAML()` or `simpleYAMLParse()`:

1. Run `node tests/test-protocol-roundtrip.js` — catches web-side regressions
2. Re-generate: `node tests/generate-roundtrip-protocol.js --outdir ...`
3. Run MATLAB: `validate_web_protocol_roundtrip('v1')` — catches cross-tool regressions

## Known Constraints

- **ProtocolRunner dry run** tries to initialize hardware (PanelsController). The MATLAB test validates construction only (parse + validate), not `run()`.
- **`ProtocolParser.m` and `CommandExecutor.m`** are Lisa's code — flagged as DO NOT MODIFY. Any incompatibilities found should be discussed before changing.
- **simpleYAMLParse** is a minimal YAML parser. It handles the subset of YAML used by the experiment designer but is not a full YAML 1.2 parser.
